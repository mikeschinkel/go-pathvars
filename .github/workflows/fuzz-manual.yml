name: Manual Fuzzing

# Manual workflow to demonstrate fuzzing capabilities
# Can be triggered manually from GitHub Actions UI
on:
  workflow_dispatch:
    inputs:
      fuzz-time:
        description: 'Fuzzing duration (e.g., 5m, 10m)'
        required: false
        default: '5m'

env:
  GO_VERSION: '1.25'
  GOEXPERIMENT: jsonv2

jobs:
  fuzz:
    name: Fuzz Testing (${{ github.event.inputs.fuzz-time }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        fuzz-target: [FuzzParseTemplate, FuzzMatch]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run fuzzing - ${{ matrix.fuzz-target }}
        run: GOEXPERIMENT=${{ env.GOEXPERIMENT }} go test -fuzz=${{ matrix.fuzz-target }} -fuzztime=${{ github.event.inputs.fuzz-time || '5m' }} ./test

      - name: Check for new corpus files
        if: always()
        id: corpus-check
        run: |
          if [ -d "test/testdata/fuzz/${{ matrix.fuzz-target }}" ]; then
            count=$(find test/testdata/fuzz/${{ matrix.fuzz-target }} -type f | wc -l)
            echo "corpus_count=$count" >> $GITHUB_OUTPUT
            echo "Found $count corpus files for ${{ matrix.fuzz-target }}"
          else
            echo "corpus_count=0" >> $GITHUB_OUTPUT
            echo "No corpus directory found"
          fi

      - name: Upload corpus artifacts
        if: steps.corpus-check.outputs.corpus_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ matrix.fuzz-target }}
          path: test/testdata/fuzz/${{ matrix.fuzz-target }}/
          retention-days: 30

      - name: Upload failures (if any)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-failures-${{ matrix.fuzz-target }}
          path: test/testdata/fuzz/${{ matrix.fuzz-target }}/
          retention-days: 30

  summary:
    name: Fuzzing Summary
    runs-on: ubuntu-latest
    needs: fuzz
    if: always()

    steps:
      - name: Post summary
        run: |
          echo "## Manual Fuzzing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Fuzz Duration**: ${{ github.event.inputs.fuzz-time || '5m' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Targets**: FuzzParseTemplate, FuzzMatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For continuous local fuzzing, use:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cd test && ./infinite-fuzz.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
